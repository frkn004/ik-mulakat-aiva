<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIVA - Mülakat</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
            min-height: 100vh;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .chat-container {
            height: calc(100vh - 16rem);
        }
        .chat-messages {
            height: calc(100% - 5rem);
            overflow-y: auto;
        }
        .message {
            max-width: 80%;
            word-wrap: break-word;
        }
        .message.ai {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }
        .message.user {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        .recording-button {
            transition: all 0.3s ease;
        }
        .recording-button.active {
            background: #ef4444;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .recording-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .recording-indicator.active {
            background: #ef4444;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .wave-animation {
            height: 40px;
            background: #f3f4f6;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }
        .wave-animation.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, var(--bar-color, #4f46e5) var(--volume), transparent var(--volume));
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="glassmorphism rounded-2xl p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">{{ interview.candidate_name }}</h1>
                    <p class="text-gray-600">{{ interview.position }}</p>
                </div>
                <div id="audioStatus" class="text-sm font-medium text-gray-600">
                    <i class="fas fa-circle text-green-500 mr-2"></i>
                    <span>Hazır</span>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="glassmorphism rounded-2xl chat-container">
            <div id="messages" class="chat-messages p-6 space-y-4">
                <!-- Hoşgeldin mesajı -->
                <div class="message ai rounded-xl p-4 text-white">
                    <p>Merhaba {{ interview.candidate_name }}, {{ interview.position }} pozisyonu için mülakatımıza hoş geldiniz. Nasılsınız?</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <!-- Ses Seviyesi -->
                    <div class="flex-1 mr-4">
                        <div class="wave-animation" id="volumeBar"></div>
                        <div class="flex justify-between items-center mt-2">
                            <div class="flex items-center space-x-2">
                                <div id="recordingIndicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                                <span id="recordingStatus" class="text-sm font-medium text-gray-600">Hazır</span>
                            </div>
                            <span id="volumeLevel" class="text-sm font-medium text-indigo-600">0%</span>
                        </div>
                    </div>

                    <!-- Kayıt Butonu -->
                    <button id="toggleRecording" 
                            class="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 
                                   transition-colors flex items-center space-x-2 disabled:opacity-50">
                        <i class="fas fa-microphone"></i>
                        <span>Kayda Başla</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder = null;
        let audioContext = null;
        let analyser = null;
        let audioStream = null;
        let isRecording = false;
        let isProcessing = false;
        let silenceThreshold = 0.02;
        let silenceDuration = 1000;
        let silenceStart = null;
        let autoRecording = true;

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Chrome için mediaDevices API'sini etkinleştir
                if (navigator.mediaDevices === undefined) {
                    navigator.mediaDevices = {};
                }

                if (navigator.mediaDevices.getUserMedia === undefined) {
                    navigator.mediaDevices.getUserMedia = function(constraints) {
                        const getUserMedia = navigator.webkitGetUserMedia ||
                                           navigator.mozGetUserMedia;

                        if (!getUserMedia) {
                            showError('Lütfen tarayıcı ayarlarından mikrofon iznini verin ve sayfayı yenileyin.');
                            return Promise.reject(new Error('getUserMedia desteklenmiyor'));
                        }

                        return new Promise((resolve, reject) => {
                            getUserMedia.call(navigator, constraints, resolve, reject);
                        });
                    };
                }

                // Ses sistemini başlat
                const initialized = await initAudioSystem();
                if (!initialized) {
                    showError('Ses sistemi başlatılamadı. Lütfen mikrofon iznini verdiğinizden emin olun.');
                    return;
                }

                // Kayıt butonunu etkinleştir
                const recordButton = document.getElementById('toggleRecording');
                recordButton.disabled = false;
                recordButton.addEventListener('click', toggleRecording);

                // Otomatik kayda başla
                setTimeout(() => {
                    if (!isRecording && !isProcessing) {
                        startRecording();
                    }
                }, 1000);

                updateStatus('Hazır', 'green');
                
            } catch (error) {
                console.error('Başlatma hatası:', error);
                showError('Lütfen tarayıcı ayarlarından mikrofon iznini verin ve sayfayı yenileyin.');
            }
        });

        // Ses seviyesi kontrolü
        function checkAudioLevel() {
            if (!analyser || !isRecording) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
            const volume = average / 128.0;
            
            updateVolumeBar(volume);

            // Sessizlik kontrolü
            if (volume < silenceThreshold) {
                if (!silenceStart) {
                    silenceStart = Date.now();
                } else if (Date.now() - silenceStart > silenceDuration) {
                    stopRecording();
                    return;
                }
            } else {
                silenceStart = null;
            }
            
            if (isRecording) {
                requestAnimationFrame(checkAudioLevel);
            }
        }

        // Ses seviyesi göstergesi
        function updateVolumeBar(volume) {
            const volumeBar = document.getElementById('volumeBar');
            const volumeLevel = document.getElementById('volumeLevel');
            
            volumeBar.style.setProperty('--volume', `${volume * 100}%`);
            volumeLevel.textContent = `${Math.round(volume * 100)}%`;
            
            if (volume > 0.7) {
                volumeBar.style.setProperty('--bar-color', '#ef4444'); // Kırmızı
            } else if (volume > 0.3) {
                volumeBar.style.setProperty('--bar-color', '#22c55e'); // Yeşil
            } else {
                volumeBar.style.setProperty('--bar-color', '#4f46e5'); // Mavi
            }
        }

        // Ses sistemini başlat
        async function initAudioSystem() {
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(audioStream);
                source.connect(analyser);
                analyser.fftSize = 2048;

                return true;
            } catch (error) {
                console.error('Ses sistemi başlatma hatası:', error);
                return false;
            }
        }

        // Kayıt başlat
        function startRecording() {
            if (isRecording || isProcessing) return;

            try {
                const options = {
                    mimeType: 'audio/webm'
                };

                mediaRecorder = new MediaRecorder(audioStream, options);
                mediaRecorder.ondataavailable = handleDataAvailable;
                mediaRecorder.onstop = handleRecordingStop;

                mediaRecorder.start();
                isRecording = true;
                updateStatus('Kayıt yapılıyor...', 'red', true);
                checkAudioLevel();

            } catch (error) {
                console.error('Kayıt başlatma hatası:', error);
                showError('Kayıt başlatılamadı');
            }
        }

        // Kayıt durdur
        function stopRecording() {
            if (!isRecording) return;

            try {
                mediaRecorder.stop();
                isRecording = false;
                updateStatus('İşleniyor...', 'yellow');
            } catch (error) {
                console.error('Kayıt durdurma hatası:', error);
                showError('Kayıt durdurulamadı');
            }
        }

        // Kayıt verisi geldiğinde
        function handleDataAvailable(event) {
            if (event.data.size > 0) {
                processAudio(event.data);
            }
        }

        // Kayıt durduğunda
        async function handleRecordingStop() {
            if (isProcessing) return;
            isProcessing = true;
            updateStatus('İşleniyor...', 'yellow');
        }

        // Kayıt durumunu değiştir
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function updateStatus(text, color, isPulse = false) {
            const recordingIndicator = document.getElementById('recordingIndicator');
            const recordingStatus = document.getElementById('recordingStatus');
            const volumeBar = document.getElementById('volumeBar');
            const toggleButton = document.getElementById('toggleRecording');
            
            const colors = {
                'red': 'bg-red-500',
                'yellow': 'bg-yellow-500',
                'green': 'bg-green-500',
                'gray': 'bg-gray-400'
            };
            
            // Tüm renk sınıflarını kaldır
            Object.values(colors).forEach(c => recordingIndicator.classList.remove(c));
            recordingIndicator.classList.add(colors[color] || colors.gray);
            
            recordingStatus.textContent = text;
            
            if (isPulse) {
                volumeBar.classList.add('active');
                toggleButton.innerHTML = '<i class="fas fa-stop-circle"></i><span>Kaydı Durdur</span>';
                toggleButton.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                volumeBar.classList.remove('active');
                toggleButton.innerHTML = '<i class="fas fa-microphone"></i><span>Kayda Başla</span>';
                toggleButton.classList.remove('bg-red-600', 'hover:bg-red-700');
            }
        }

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender} rounded-xl p-4 text-white ${sender === 'user' ? 'ml-auto' : 'mr-auto'}`;
            messageDiv.innerHTML = `<p>${text}</p>`;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function speakText(text) {
            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'tr-TR';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                
                utterance.onend = () => {
                    resolve();
                };
                
                utterance.onerror = () => {
                    resolve();
                };
                
                window.speechSynthesis.speak(utterance);
            });
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(errorDiv);
            
            // 5 saniye sonra kaldır
            setTimeout(() => {
                errorDiv.classList.add('opacity-0');
                setTimeout(() => errorDiv.remove(), 300);
            }, 5000);
        }

        // Ses kaydını işle
        async function processAudio(audioBlob) {
            if (isProcessing) return;
            isProcessing = true;

            try {
                const formData = new FormData();
                formData.append('audio', audioBlob);

                const response = await fetch('/process_audio', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    if (result.transcript) {
                        addMessage(result.transcript, 'user');
                    }
                    if (result.response) {
                        addMessage(result.response, 'ai');
                        await speakText(result.response);
                    }

                    // Ses seviyesi göstergesini güncelle
                    if (result.volume_level !== undefined) {
                        updateVolumeBar(result.volume_level / 100);
                    }

                    updateStatus('Hazır', 'green');

                    // Otomatik kayıt - Mülakat tamamlanmadıysa devam et
                    if (!result.interview_completed) {
                        setTimeout(() => {
                            if (!isRecording && !isProcessing) {
                                startRecording();
                            }
                        }, 1000);
                    }
                } else {
                    showError(result.error || 'Ses işlenemedi');
                    
                    // Hata durumunda da otomatik kayda devam et
                    if (result.continue_listening) {
                        setTimeout(() => {
                            if (!isRecording && !isProcessing) {
                                startRecording();
                            }
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('Ses işleme hatası:', error);
                showError('Ses işlenirken bir hata oluştu');
                
                // Hata durumunda da otomatik kayda devam et
                setTimeout(() => {
                    if (!isRecording && !isProcessing) {
                        startRecording();
                    }
                }, 1000);
            } finally {
                isProcessing = false;
            }
        }
    </script>
</body>
</html> 